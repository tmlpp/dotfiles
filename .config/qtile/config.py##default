from libqtile import bar, layout, qtile, widget, hook
from libqtile.config import Click, Drag, Group, Key, KeyChord, Match, Screen, ScratchPad, DropDown
from libqtile.lazy import lazy
import os
import random
import subprocess
import my_widgets

mod = "mod4"
terminal = 'kitty'

themes_path = os.path.expanduser('~/.config/qtile/themes/')

random_theme = True

if random_theme:
    with os.scandir(themes_path) as m:
        themes = [t.name for t in list(m)]
    theme = random.choice(themes)
else:
    theme = 'gruvbox-dark-soft'

with open(os.path.expanduser(f'~/.config/qtile/themes/{theme}'), 'r') as f:
    colors = {}
    for l in f.readlines()[2:]:
        key, val = l.split()[:2]
        colors[key.strip(':')] = val.strip('"')
    

# Use the prompt to get a name for new group in treetab layout
@lazy.layout.function
def add_treetab_section(layout):
    prompt = qtile.widgets_map["prompt"]
    prompt.start_input("Section name: ", layout.cmd_add_section)

keys = [
    Key([mod], "h", lazy.layout.left(), desc="Move focus to left"),
    Key([mod], "l", lazy.layout.right(), desc="Move focus to right"),
    Key([mod], "j", lazy.layout.down(), desc="Move focus down"),
    Key([mod], "k", lazy.layout.up(), desc="Move focus up"),

    Key([mod, "shift"], "h",
        lazy.layout.shuffle_left(),
        lazy.layout.move_left(),
        desc="Move/shuffle window or tab left"),
    Key([mod, "shift"], "l",
        lazy.layout.shuffle_right(),
        lazy.layout.move_right(),
        desc="Move/shuffle window or tab right"),
    Key([mod, "shift"], "j",
        lazy.layout.shuffle_down(),
        lazy.layout.move_down(),
        desc="Move/shuffle window or tab down"),
    Key([mod, "shift"], "k",
        lazy.layout.shuffle_up(),
        lazy.layout.move_up(),
        desc="Move/shuffle window or tab up"),

    Key([mod, "control"], "j",
        lazy.layout.grow(), # Monad
        lazy.layout.grow_down(),
        lazy.layout.section_down(),
        lazy.layout.decrease_nmaster(),
        desc="Grow window down or move to next section."),
    Key([mod, "control"], "k",
        lazy.layout.shrink(), # Monad
        lazy.layout.grow_up(),
        lazy.layout.section_up(),
        lazy.layout.increase_nmaster(),
        desc="Grow window up or move to previous section."),
    Key([mod, "control"], "h",
        lazy.layout.shrink_main(), # Monad
        lazy.layout.grow_left(), # Column, BSP
        lazy.layout.decrease_ratio(),
        desc="Move window to the right/move tab right in treetab"),
    Key([mod, "control"], "l",
        lazy.layout.grow_main(), # Monad
        lazy.layout.grow_right(), # Column, BSP
        lazy.layout.increase_ratio(),
        desc="Move window to the right/move tab right in treetab"),

    Key([mod], "q", lazy.window.kill(), desc="Kill focused window"),
    Key([mod], "f", lazy.window.toggle_fullscreen(), desc="Toggle fullscreen on the focused window",),
    Key([mod], "m", lazy.window.toggle_minimize(), desc="Toggle fullscreen on the focused window",),
    Key([mod], "bracketright", lazy.screen.next_group()),
    Key([mod], "bracketleft", lazy.screen.prev_group()),
    Key([mod, "control"], "r", lazy.reload_config(), desc="Reload the config"),
    Key([mod, "control"], "q", lazy.shutdown(), desc="Shutdown Qtile"),
    Key([mod], "Tab", lazy.layout.next(), desc="Move window focus to other window"),
    Key([mod, 'shift'], "Tab", lazy.layout.previous(), desc="Move window focus to other window"),
    Key([mod], "period", lazy.group.next_window(), desc="Move window focus to other window"),
    Key([mod], "comma", lazy.group.prev_window(), desc="Move window focus to other window"),
    Key([mod], "Return", lazy.spawn(terminal), desc="Launch terminal"),
    Key([mod, "shift"], "Return", lazy.layout.toggle_split(), desc="Toggle between split and unsplit sides of stack",),
    Key([mod], "Menu", lazy.spawn("rofi -show run")),
    Key([mod], "Escape", lazy.spawn("system-menu")),
    Key([mod], "g", lazy.next_screen()),
    Key([mod], "y", lazy.window.toggle_floating(), desc="Toggle floating on the focused window"),
    Key([mod], "r", lazy.spawncmd(), desc="Spawn a command using a prompt widget"),
    Key([mod], "F8", lazy.spawn("keepassxc")),
    Key([mod], "n", lazy.layout.normalize(), desc="Reset all window sizes"),
    Key([mod, "shift"], "a", add_treetab_section, desc='Prompt to add new section in treetab'),
    Key([mod], 't', lazy.group['scratchpad'].dropdown_toggle('term')),
    Key([mod], 'c', lazy.group['scratchpad'].dropdown_toggle('calculator')),

    # Volume and media
    Key([mod], "F1", lazy.spawn("volume-mute")),
    Key([mod], "F2", lazy.spawn("volume-down")),
    Key([mod], "F3", lazy.spawn("volume-up")),
    Key([mod], "F4", lazy.spawn("playerctl --player=spotify play-pause")),
    Key([mod], "F5", lazy.spawn("playerctl --player=spotify previous")),
    Key([mod], "F6", lazy.spawn("playerctl --player=spotify next")),

    # Screenshots
    Key([], "Print", lazy.spawn("flameshot screen")), # Fullscreen, save
    Key(["shift"], "Print", lazy.spawn("flameshot gui")), # Select area
    Key(["control"], "Print", lazy.spawn("flameshot screen --clipboard")), # Fullscreen, clipboard
    Key([mod], "Print", lazy.spawn("scrot -u '%Y-%m-%d_%H%M%S.png' -e 'mv $f ~/screenshots/'")), # Save active window

    Key([mod, "control"], "c", lazy.spawn("emacsclient -e '(make-capture-frame)'")),
    KeyChord([mod], "b", [
        Key([], "j", lazy.hide_show_bar('bottom')),
        Key([], "k", lazy.hide_show_bar('top')),
        Key([], "b", lazy.hide_show_bar()),
    ])
]

groups = [
    Group(name='1',
          label='main',
          ),
    Group(name='2',
          label='dev',
          ),
    Group(name='3',
          label='media',
          ),
    Group(name='4',
          label='cgi',
          ),
    Group(name='5',
          label='msg',
          ),
    ScratchPad("scratchpad", [
        DropDown("term", terminal,
                 x=0.25, y=0.25,
                 width=0.5, height=0.5,
                 on_focus_lost_hide=True,
                 warp_pointer=False),
        DropDown("calculator", "speedcrunch",
                 x=0.78, y=0.02,
                 width=0.2, height=0.3,
                 on_focus_lost_hide=True,
                 warp_pointer=False),
    ]),
]

for i in groups[:-1]:
    keys.extend([
            Key([mod], i.name, lazy.group[i.name].toscreen(), desc=f"Switch to group {i.label}"),
            Key([mod, "shift"], i.name, lazy.window.togroup(i.name, switch_group=False),
                desc=f"move focused window to group {i.label}"),
    ])

borders = dict(
    border_normal=colors['base04'],
    border_focus=colors['base07'],
    border_normal_stack=colors['base0D'],
    border_focus_stack=colors['base0B'],
    border_width = 2,
)


layouts = [
    layout.Max(
        name='0 MAX',
        margin = 8,
    ),
    layout.MonadTall(
        name = '1 MONADTALL',
        margin = 8,
        **borders,
    ),
    layout.Bsp(
        name = '2 BSP',
        margin = 4,
        **borders,
    ),
    layout.TreeTab(
        name='3 TAB',
        bg_color = colors['base00'], # Background color of tabs
        active_bg = colors['base07'], # Background color of active tab
        active_fg = colors['base00'], # Foreground color of active tab
        inactive_bg = colors['base03'], # Background color of inactive tab
        inactive_fg = colors['base07'], # Foreground color of inactive tab
        border_width = 0, # Width of the border
        font = 'Ubuntu Mono', # Font
        fontshadow = None, # font shadow color, default is None (no shadow)
        fontsize = 14, # Font pixel size.
        level_shift = 20, # Shift for children tabs
        margin_left = 0, # Left margin of tab panel
        margin_y = 0, # Vertical margin of tab panel
        padding_left = 0, # Left padding for tabs
        padding_x = 5, # Left padding for tab label
        padding_y = 5, # Top padding for tab label
        panel_width = 200, # Width of the left panel
        place_right = True, # Place the tab panel on the right side
        previous_on_rm = False, # Focus previous window on close instead of first.
        section_bottom = 10, # Bottom margin of section
        section_fg = colors['base07'], # Color of section label
        section_fontsize = 14, # Font pixel size of section label
        section_left = 10, # Left margin of section label
        section_padding = 5, # Bottom of margin section label
        section_top = 5, # Top margin of section label
        sections = ['Default', 'Foo', 'Bar'], # Titles of section instances
        urgent_bg = colors['base08'], # Background color of urgent tab
        urgent_fg = colors['base07'], # Foreground color of urgent tab
        vspace = 3, # Space between tabs
    ),
    layout.Columns(
        name='4 COL',
        margin = 8,
        **borders,
    ),
    layout.Tile(
        name = '5 TILE',
        margin = 8,
        **borders,
    ),
    # layout.Stack(num_stacks=2),
    # layout.Matrix(),
    # layout.MonadWide(),
    # layout.RatioTile(
    # ),
    # layout.VerticalTile(),
    # layout.Zoomy(),
]

keys.extend([
    KeyChord([mod], "space", [
        Key([], "j", lazy.next_layout(), desc="Toggle between layouts"),
        Key([], "k", lazy.next_layout(), desc="Toggle between layouts"),
        Key([], "h", lazy.to_layout_index(0), desc="Switch to default layout"),
        # Use number keys to switch directly to nth layout. '0' is the first/default
        *[Key([], str(i), lazy.to_layout_index(i), desc=f'Switch to layout number {i}') for i in range(len(layouts))]
    ])
])

widget_defaults = dict(
    font="Ubuntu Mono",
    fontsize=14,
    foreground=colors['base07'],
    background=colors['base00'],
    padding=10,
)
extension_defaults = widget_defaults.copy()

bar_defaults = dict(
    border_width=[0, 0, 0, 0],
    border_color=[colors['base07'], "000000", colors['base07'], "000000"]
)

groupbox_defaults = dict(
    highlight_method = 'block',
    active = colors['base04'],
    inactive = colors['base03'],
    block_highlight_text_color = colors['base00'],
    borderwidth = 0,
    margin_x = 0,
    margin_y = 3,
    rounded = False,
    this_current_screen_border = colors['base07'], # Active screen's group active screen
    other_screen_border = colors['base04'], # Inactive screen's group on active screen
    this_screen_border = colors['base05'], # Inactive screen's group on inactive screen 
    other_current_screen_border = colors['base00'], # Active screen's group inactive screen
    padding_x = 10,
    padding_y = 8,
)

monitored_disks = ['/', '/home', '/amanda', '/bella', '/cecilia', '/diana', '/ella', '/freya']

graph_defaults = dict(
    border_width = 1,
    type = 'line',
    line_width = 1,
)

tasklist_defaults = dict(
    highlight_method = 'block',
    max_title_width = 200,
    title_width_method = 'uniform',
    foreground = colors['base07'],
    border = colors['base07'],
    markup_floating = "<i>{}</i>",
    markup_focused = f'<span color="#{colors['base00']}"><b>{{}}</b></span>',
    margin=0,
    padding=5,
    rounded = False,
    window_name_location = True,
    window_name_location_offset = 1,
)

current_screen_defaults = dict(
    active_color = colors['base07'],
    inactive_color = colors['base09'],
    active_text = '★ ★ ★',
    inactive_text = '☆ ☆ ☆',
    fmt='<b>{}</b>'
)

screens = [
    Screen(
        top=bar.Bar(
            [
                widget.GroupBox(
                    **groupbox_defaults,
                ),
                widget.Prompt(),
                widget.TaskList(
                    **tasklist_defaults,
                ),
                widget.Chord(
                    chords_colors={
                        "launch": ("#ff0000", "#ffffff"),
                    },
                    name_transform=lambda name: name.upper(),
                ),
                # widget.StatusNotifier(),
                my_widgets.NordPoolPrice(
                    vat_percent = 25.5,
                    transfer_fee = 1.67331,
                    energy_tax = 2.253,
                    notify_price_change = False,
                ),
                widget.MemoryGraph(
                    **graph_defaults,
                    width = 60,
                    samples = 60,
                    graph_color = colors['base0D'],
                    border_color = colors['base0D'],
                ),
                *[
                    widget.CPUGraph(
                        **graph_defaults,
                        core = i,
                        width = 30,
                        graph_color = colors['base0A'],
                        border_color = colors['base0A'],
                        samples=15,
                    ) for i in range(os.cpu_count() // 2)
                ],
                widget.Volume(
                    emoji=True,
                ),
                widget.Memory(),
                widget.Systray(),
                widget.Clock(format="W%V | %a %d %b | %H:%M"),
            ],
            24,
            **bar_defaults
        ),
        bottom=bar.Bar(
            [
                widget.Clock(format="W%V | %a %d %b | %H:%M"),
                widget.OpenWeather(
                    location='Jyväskylä',
                ),
                *[widget.DF(
                    partition=i,
                    visible_on_warn=False,
                    foreground=colors['base0D'],
                    warn_color=colors['base09'],
                    warn_space=2,
                    format='{p} {uf}{m}|{r:.0f}%'
                ) for i in monitored_disks],
                widget.Spacer(length=bar.STRETCH),
                # widget.Pomodoro(
                #     color_active = colors['base07'],
                #     color_break = colors['base07'],
                #     color_inactive = colors['base07'],
                #     length_long_break = 15,
                #     length_pomodori = 20,
                #     length_short_break = 15,
                #     prefix_active = 'SIT ',
                #     prefix_inactive = 'SIT/STAND',
                #     prefix_break = 'STAND ',
                #     prefix_long_break = 'STAND ',
                #     prefix_paused = 'AFK',
                # ),
                widget.CurrentScreen(
                    **current_screen_defaults
                ),
                widget.CurrentLayout(),
            ],
            24,
            **bar_defaults
        ),
    ),
    Screen(
        top=bar.Bar(
            [
                widget.Clock(format="W%V | %a %d %b | %H:%M"),
            ],
            24,
            **bar_defaults
        ),
        bottom=bar.Bar(
            [
                widget.Clock(format="W%V | %a %d %b | %H:%M"),
                widget.GroupBox(
                    **groupbox_defaults,
                ),
                widget.TaskList(
                    **tasklist_defaults,
                ),
                widget.Spacer(length=bar.STRETCH),
                widget.CurrentScreen(
                    **current_screen_defaults
                ),
                widget.CurrentLayout(),
            ],
            24,
            **bar_defaults
        )
    ),
]

mouse = [
    Drag([mod], "Button1", lazy.window.set_position_floating(), start=lazy.window.get_position()),
    Drag([mod], "Button3", lazy.window.set_size_floating(), start=lazy.window.get_size()),
    Click([mod], "Button2", lazy.window.bring_to_front()),
]

dgroups_key_binder = None
dgroups_app_rules = []  # type: list
follow_mouse_focus = True
bring_front_click = False
floats_kept_above = True
cursor_warp = False
floating_layout = layout.Floating(
    float_rules=[
        *layout.Floating.default_float_rules,
        Match(wm_class="confirmreset"),  # gitk
        Match(wm_class="makebranch"),  # gitk
        Match(wm_class="maketag"),  # gitk
        Match(wm_class="ssh-askpass"),  # ssh-askpass
        Match(title="branchdialog"),  # gitk
        Match(title="pinentry"),  # GPG key password entry
        Match(wm_class='PureRef'),
        Match(title='Blender Preferences'),
        Match(title='capture'),
        Match(wm_class='qalculate-gtk'),
        Match(wm_class='speedcrunch'),
        Match(wm_class='zoom'),
        Match(wm_class='Godot_Engine'),
    ]
)
auto_fullscreen = False
focus_on_window_activation = "urgent"
reconfigure_screens = True

@hook.subscribe.startup_once
def startup_once():
    startup_file = os.path.expanduser('~/.config/qtile/startup_once')
    subprocess.call([startup_file])

auto_minimize = True

wl_input_rules = None

wmname = "LG3D"

# /* vim: set filetype=python : */
